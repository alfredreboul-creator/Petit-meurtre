<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Archives Criminelles</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--blood:#991b1b;--paper:#f1f0ea;--ink:#111827;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Courier Prime',monospace;background:#0a0a0a;color:#e5e7eb;min-height:100vh;padding:16px 16px 40px;display:flex;flex-direction:column;align-items:center;}
.elite{font-family:'Special Elite',serif;}
header{width:100%;max-width:500px;border-bottom:6px solid #7f1d1d;padding-bottom:12px;margin-bottom:28px;}
h1{font-family:'Special Elite',serif;font-size:1.8rem;color:#991b1b;text-transform:uppercase;letter-spacing:-0.02em;}
.sub{font-size:8px;color:#52525b;letter-spacing:0.35em;font-weight:700;margin-top:3px;}

.screen{width:100%;max-width:500px;display:none;}
.screen.active{display:block;}

/* FOLDER */
.folder{background:var(–paper);color:var(–ink);box-shadow:8px 8px 0 #000;border:1px solid #94a3b8;padding:24px;margin-bottom:16px;}
.stamp{border:4px solid var(–blood);color:var(–blood);padding:3px 12px;text-transform:uppercase;font-weight:900;transform:rotate(-10deg);display:inline-block;font-family:‘Special Elite’;font-size:1rem;margin-bottom:16px;}

/* BUTTONS */
.btn{display:block;width:100%;padding:20px;font-family:‘Special Elite’;font-size:1.15rem;text-transform:uppercase;letter-spacing:0.08em;cursor:pointer;border:none;text-align:center;margin-bottom:10px;}
.btn-red{background:#991b1b;color:#fff;border-bottom:5px solid #450a0a;}
.btn-red:active{transform:translateY(3px);border-bottom-width:2px;}
.btn-dark{background:#18181b;color:#a1a1aa;border:2px solid #27272a;}
.btn-dark:active{background:#27272a;}
.btn-grey{background:#27272a;color:#71717a;border:none;}

/* INPUTS */
input[type=text]{width:100%;background:#fff;border:none;border-bottom:4px solid #d4d4d8;padding:14px;font-size:1.3rem;font-weight:700;font-family:‘Courier Prime’,monospace;outline:none;color:#111;margin-bottom:4px;}
input[type=text]:focus{border-bottom-color:#991b1b;}
label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#71717a;margin-bottom:6px;margin-top:16px;}

/* ROLE BUTTONS */
.role-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0;}
.role-btn{border:2px solid #27272a;padding:16px 8px;text-align:center;cursor:pointer;background:#0a0a0a;}
.role-btn.active{border-color:#991b1b;background:#1a0505;}
.role-btn span{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:#a1a1aa;}
.role-btn small{font-size:9px;color:#52525b;font-style:italic;margin-top:4px;display:block;}

/* CALENDAR */
.cal-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:12px;}
.cal-day{aspect-ratio:1;background:#111;border:2px solid #222;display:flex;align-items:center;justify-content:center;font-family:‘Special Elite’;font-size:1.2rem;cursor:pointer;transition:0.2s;}
.cal-day.sel{background:#991b1b;color:#fff;border-color:#ef4444;box-shadow:0 0 12px #991b1b88;transform:scale(1.08);}

/* PLAYER CARDS */
.player-card{background:#18181b;border-left:4px solid #27272a;padding:16px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.player-card.inv{border-left-color:#991b1b;}
.pname{font-weight:900;color:#d4d4d8;font-size:1rem;}
.pbadge{font-size:8px;font-weight:700;padding:3px 8px;background:#000;border:1px solid #27272a;color:#71717a;letter-spacing:0.2em;}
.pbadge.police{border-color:#7f1d1d;color:#dc2626;}

/* SUSPECT LIST (inspector) */
.suspect-card{background:#18181b;border-left:6px solid #27272a;padding:16px;margin-bottom:12px;}
.suspect-card.guilty{border-left-color:#991b1b;}
.sname{font-size:1rem;font-weight:900;text-transform:uppercase;color:#e5e7eb;margin-bottom:6px;display:flex;justify-content:space-between;}
.srole{font-size:10px;font-weight:700;letter-spacing:0.2em;}
.srole.g{color:#dc2626;}
.srole.i{color:#52525b;}
.spv{font-size:11px;color:#71717a;font-style:italic;line-height:1.6;margin-bottom:8px;}
.swords{font-size:11px;font-weight:700;color:#a1a1aa;}
.sword-label{background:#111;color:#fff;padding:1px 6px;font-size:9px;letter-spacing:0.1em;}
.sword-label.r{background:#7f1d1d;}

/* PLAYER FLOW */
.flow-step{display:none;}
.flow-step.active{display:block;}

.big-role{font-size:3.5rem;font-weight:900;text-transform:uppercase;letter-spacing:-0.03em;line-height:1;margin:12px 0 24px;}
.pv-text{font-size:13px;line-height:1.9;font-style:italic;color:#374151;font-weight:700;}
.word-card{background:#fff;border-left:6px solid #991b1b;padding:18px 20px;margin-bottom:10px;font-size:1.5rem;font-weight:900;text-transform:uppercase;letter-spacing:-0.02em;color:#111;}
.step-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#991b1b;border-bottom:3px solid #991b1b;padding-bottom:6px;margin-bottom:14px;}

/* TIMER */
.timer-wrap{border-bottom:2px solid #7f1d1d;padding-bottom:16px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
.timer-num{font-size:5rem;font-weight:900;color:#fff;letter-spacing:-0.05em;line-height:1;}
.timer-phase{display:inline-block;background:#7f1d1d;color:#fff;font-size:9px;font-weight:700;padding:4px 10px;text-transform:uppercase;letter-spacing:0.2em;margin-top:6px;}
.timer-day{font-family:‘Special Elite’;font-size:2.2rem;color:#7f1d1d;font-weight:900;}

/* WAITING */
.waiting{background:#18181b;border:1px solid #27272a;padding:24px;text-align:center;margin-bottom:16px;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

/* ERROR */
.err{background:#450a0a;border:1px solid #991b1b;color:#fca5a5;padding:10px;font-size:11px;font-weight:700;text-transform:uppercase;display:none;margin-top:8px;}

/* CODE BADGE */
#code-badge{display:none;text-align:right;margin-bottom:4px;}
.code-val{font-size:1.3rem;font-weight:900;color:#fff;font-family:monospace;background:#7f1d1d22;padding:2px 12px;border:1px solid #7f1d1d55;letter-spacing:0.3em;}

/* PROGRESS DOTS */
.dots{display:flex;gap:6px;justify-content:center;margin-bottom:20px;}
.dot{width:8px;height:8px;border-radius:50%;background:#27272a;}
.dot.active{background:#991b1b;}
.dot.done{background:#52525b;}
</style>

</head>
<body>

<header>
  <h1 class="elite">Archives Criminelles</h1>
  <p class="sub">Accès restreint // Sécurité nationale</p>
</header>

<div id="code-badge"><span class="code-val" id="code-val"></span></div>

<!-- ═══════ HOME ═══════ -->

<div id="s-home" class="screen active">
  <div class="folder">
    <div class="stamp">Identité</div>
    <h3 class="elite" style="font-size:1.3rem;font-weight:900;margin-bottom:20px;text-decoration:underline;text-decoration-color:#991b1b;">Qui se présente ?</h3>
    <div class="role-grid">
      <div class="role-btn" id="rbtn-inv" onclick="pickRole('investigator')">
        <span>L'Inspecteur</span><small>Interroge &amp; dirige</small>
      </div>
      <div class="role-btn active" id="rbtn-acc" onclick="pickRole('accused')">
        <span>L'Accusé</span><small>Ment pour survivre</small>
      </div>
    </div>
    <label>Votre nom / alias</label>
    <input type="text" id="inp-name" placeholder="Ex: Dupont...">
    <div id="err-name" class="err">Entrez votre nom d'abord.</div>
  </div>
  <button class="btn btn-red" onclick="createGame()">Ouvrir un dossier (Hôte)</button>
  <div class="folder" style="margin-top:8px;">
    <label>Code de session (pour rejoindre)</label>
    <input type="text" id="inp-code" placeholder="EX: A1B2" maxlength="4" style="text-transform:uppercase;letter-spacing:0.3em;font-size:1.5rem;">
    <div id="err-code" class="err">Code invalide.</div>
    <button class="btn btn-dark" style="margin-top:12px;" onclick="joinGame()">Rejoindre la session</button>
  </div>
</div>

<!-- ═══════ HOST LOBBY ═══════ -->

<div id="s-host-lobby" class="screen">
  <div class="folder">
    <p style="font-size:10px;color:#71717a;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:8px;">Code à partager avec les joueurs :</p>
    <div style="font-size:3.5rem;font-weight:900;font-family:monospace;letter-spacing:0.5em;color:#991b1b;text-align:center;padding:20px;background:#fff;border:4px solid #991b1b;" id="host-code-big"></div>
    <p style="font-size:10px;color:#71717a;text-align:center;margin-top:8px;">Les joueurs entrent ce code sur <strong style="color:#fff;">la même URL</strong></p>
  </div>
  <div class="folder">
    <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#71717a;margin-bottom:10px;">Joueurs connectés :</p>
    <div id="host-player-list"></div>
    <button class="btn btn-grey" style="margin-top:10px;font-size:10px;" onclick="addPlayerManual()">+ Ajouter un joueur</button>
  </div>
  <div class="folder">
    <p class="elite" style="color:#991b1b;font-size:1rem;font-weight:700;margin-bottom:14px;text-decoration:underline;">Choisir le jour de l'affaire :</p>
    <div class="cal-grid" id="host-cal"></div>
  </div>
  <button class="btn btn-red" onclick="hostGoBriefing()">Diffuser le rapport de crime →</button>
</div>

<!-- ═══════ PLAYER LOBBY ═══════ -->

<div id="s-player-lobby" class="screen">
  <div class="folder">
    <div class="stamp">En attente</div>
    <p style="font-size:1.2rem;font-weight:900;color:#111;margin-bottom:8px;" id="pl-name"></p>
    <p style="font-size:11px;color:#52525b;">Rôle choisi : <strong id="pl-role-txt"></strong></p>
  </div>
  <div class="waiting">
    <p class="pulse" style="font-size:10px;color:#991b1b;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;">En attente du commissaire...</p>
    <p style="font-size:9px;color:#52525b;margin-top:8px;">Il va lancer l'affaire d'un moment à l'autre</p>
  </div>
  <div class="folder" style="background:#111;color:#fff;">
    <p style="font-size:10px;color:#71717a;margin-bottom:4px;">Session :</p>
    <p style="font-size:2rem;font-weight:900;font-family:monospace;letter-spacing:0.4em;color:#991b1b;" id="pl-code-show"></p>
  </div>
</div>

<!-- ═══════ BRIEFING HOST ═══════ -->

<div id="s-briefing-host" class="screen">
  <div class="folder" style="max-height:60vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
      <div class="stamp">Preuve A</div>
      <span id="bh-day" class="elite" style="font-size:2rem;color:#991b1b;font-weight:900;"></span>
    </div>
    <h2 id="bh-title" style="font-size:1.2rem;font-weight:900;text-transform:uppercase;border-bottom:4px solid #111;padding-bottom:8px;margin-bottom:14px;line-height:1.3;"></h2>
    <div style="background:#111;color:#fff;padding:3px 10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;display:inline-block;margin-bottom:10px;">Rapport d'enquête :</div>
    <p id="bh-desc" style="font-size:12px;line-height:1.9;color:#374151;font-style:italic;"></p>
  </div>
  <div style="background:#0a0a0a;border:1px solid #27272a;padding:16px;margin-bottom:12px;">
    <p style="font-size:10px;color:#71717a;font-weight:700;text-transform:uppercase;margin-bottom:12px;">Liste des suspects &amp; leurs dossiers :</p>
    <div id="bh-suspect-list"></div>
  </div>
  <button class="btn btn-red" onclick="hostLaunch()">Lancer l'interrogatoire →</button>
</div>

<!-- ═══════ PLAYER FLOW ═══════ -->

<div id="s-player-flow" class="screen">
  <div class="dots" id="flow-dots"></div>

  <!-- STEP 0: Qui suis-je ? -->

  <div class="flow-step active" id="step-0">
    <div class="folder">
      <div class="stamp">Dossier confidentiel</div>
      <div class="step-title" style="margin-top:8px;">Votre identité dans cette affaire</div>
      <p style="font-size:11px;color:#52525b;margin-bottom:8px;">Affaire du <strong id="p0-day"></strong></p>
      <div id="p0-role" class="big-role"></div>
      <p style="font-size:11px;color:#52525b;font-style:italic;">Lisez attentivement ce qui suit.</p>
    </div>
    <button class="btn btn-red" onclick="nextStep()">L'affaire →</button>
  </div>

  <!-- STEP 1: L'affaire -->

  <div class="flow-step" id="step-1">
    <div class="folder" style="max-height:65vh;overflow-y:auto;">
      <div class="step-title">L'affaire</div>
      <h2 id="p1-title" style="font-size:1.1rem;font-weight:900;text-transform:uppercase;border-bottom:3px solid #111;padding-bottom:8px;margin-bottom:12px;line-height:1.3;"></h2>
      <p id="p1-desc" style="font-size:12px;line-height:1.9;color:#374151;font-style:italic;"></p>
    </div>
    <button class="btn btn-red" onclick="nextStep()">Mon nom →</button>
  </div>

  <!-- STEP 2: Mon nom -->

  <div class="flow-step" id="step-2">
    <div class="folder">
      <div class="step-title">Votre identité déclarée</div>
      <p style="font-size:2.5rem;font-weight:900;font-family:'Special Elite';color:#111;" id="p2-name"></p>
      <p style="font-size:11px;color:#52525b;margin-top:8px;">C'est sous ce nom que vous comparaissez.</p>
    </div>
    <button class="btn btn-red" onclick="nextStep()">Pourquoi je suis suspect →</button>
  </div>

  <!-- STEP 3: Suspicion -->

  <div class="flow-step" id="step-3">
    <div class="folder">
      <div class="step-title">Procès-verbal d'interpellation</div>
      <p id="p3-pv" class="pv-text"></p>
    </div>
    <button class="btn btn-red" onclick="nextStep()">Mes mots — Tour 1 →</button>
  </div>

  <!-- STEP 4: Mots tour 1 -->

  <div class="flow-step" id="step-4">
    <div class="folder">
      <div class="step-title">Éléments de langage — Tour 1</div>
      <p style="font-size:11px;color:#52525b;margin-bottom:14px;">Placez naturellement ces mots dans vos réponses pendant l'interrogatoire :</p>
      <div id="p4-words"></div>
    </div>
    <div class="timer-wrap" style="border-top:2px solid #7f1d1d;border-bottom:none;padding-top:16px;padding-bottom:0;margin-bottom:0;margin-top:8px;">
      <div>
        <div class="timer-num" id="p-timer">01:30</div>
        <div class="timer-phase" id="p-phase">Tour 1 en cours</div>
      </div>
      <div class="timer-day" id="p-day"></div>
    </div>
    <button class="btn btn-dark" style="margin-top:10px;" onclick="nextStep()">Tour 2 — Confrontation →</button>
  </div>

  <!-- STEP 5: Mots tour 2 -->

  <div class="flow-step" id="step-5">
    <div class="folder">
      <div class="step-title">Éléments de langage — Tour 2 (Confrontation)</div>
      <p style="font-size:11px;color:#52525b;margin-bottom:14px;">Tous vos mots maintenant :</p>
      <div id="p5-words"></div>
    </div>
    <div class="timer-wrap" style="border-top:2px solid #7f1d1d;border-bottom:none;padding-top:16px;padding-bottom:0;margin-bottom:0;margin-top:8px;">
      <div>
        <div class="timer-num" id="p-timer2">01:30</div>
        <div class="timer-phase">Tour 2 — Confrontation</div>
      </div>
      <div class="timer-day" id="p-day2"></div>
    </div>
  </div>
</div>

<!-- ═══════ INSPECTOR FLOW ═══════ -->

<div id="s-inspector-flow" class="screen">
  <div class="dots" id="insp-dots"></div>

  <!-- STEP 0 -->

  <div class="flow-step active" id="istep-0">
    <div class="folder">
      <div class="stamp">Confidentiel</div>
      <div class="step-title" style="margin-top:8px;">Votre rôle</div>
      <div class="big-role" style="color:#1e293b;">Enquêteur</div>
      <p style="font-size:11px;color:#52525b;">Vous dirigez l'interrogatoire. Vous seul connaissez la vérité.</p>
    </div>
    <button class="btn btn-red" onclick="nextInspStep()">L'affaire →</button>
  </div>

  <!-- STEP 1: affaire -->

  <div class="flow-step" id="istep-1">
    <div class="folder" style="max-height:55vh;overflow-y:auto;">
      <div class="step-title">L'affaire — Jour <span id="i1-day"></span></div>
      <h2 id="i1-title" style="font-size:1.1rem;font-weight:900;text-transform:uppercase;border-bottom:3px solid #111;padding-bottom:8px;margin-bottom:12px;line-height:1.3;"></h2>
      <p id="i1-desc" style="font-size:12px;line-height:1.9;color:#374151;font-style:italic;"></p>
    </div>
    <button class="btn btn-red" onclick="nextInspStep()">Liste des suspects →</button>
  </div>

  <!-- STEP 2: suspects -->

  <div class="flow-step" id="istep-2">
    <div class="folder" style="max-height:70vh;overflow-y:auto;">
      <div class="step-title">Tableau des suspects — Vérité nue</div>
      <div id="insp-suspect-list"></div>
    </div>
    <div class="timer-wrap" style="border-top:2px solid #7f1d1d;border-bottom:none;padding-top:16px;padding-bottom:0;margin-bottom:0;margin-top:8px;">
      <div>
        <div class="timer-num" id="i-timer">01:30</div>
        <div class="timer-phase" id="i-phase">Tour 1 — Mise en accusation</div>
      </div>
      <div class="timer-day" id="i-day"></div>
    </div>
    <button class="btn btn-red" style="margin-top:10px;" onclick="nextInspStep()">Tour 2 — Confrontation →</button>
  </div>

  <!-- STEP 3: tour 2 -->

  <div class="flow-step" id="istep-3">
    <div class="folder" style="max-height:70vh;overflow-y:auto;">
      <div class="step-title">Tour 2 — Mots supplémentaires débloqués</div>
      <div id="insp-suspect-list2"></div>
    </div>
    <div class="timer-wrap" style="border-top:2px solid #7f1d1d;border-bottom:none;padding-top:16px;padding-bottom:0;margin-bottom:0;margin-top:8px;">
      <div>
        <div class="timer-num" id="i-timer2">01:30</div>
        <div class="timer-phase">Tour 2 — Confrontation</div>
      </div>
      <div class="timer-day" id="i-day2"></div>
    </div>
    <button class="btn btn-dark" style="margin-top:10px;" onclick="inspReset()">Classer l'affaire</button>
  </div>
</div>

<script>
// ══════════════════════════════════════════
// SCENARIOS
// ══════════════════════════════════════════
const CASES=[
  {t:"L'Attentat à la Mousse de Canard Explosive",d:"Le 12 Janvier, à la réception de l'Ambassade de Groland, un buffet a dévasté la salle de bal. Le coupable aurait dissimulé de la nitroglycérine dans une terrine de foie gras millésimée. L'explosion fut si puissante qu'on retrouva des cornichons incrustés dans les tableaux à 50 mètres. Le mobile : une vengeance pour une dégustation jugée insultante par le gang des Goulus.",wI:["Terrine","Cornichon","Buffet"],wI2:["Pâté","Foie Gras"],wG:["Nitrate","Vengeance","Gavage"],wG2:["Poudre","Sabotage"],susp:["Aperçu près du buffet à 19h58, tenant une cuillère en argent d'un air fiévreux. Un témoin vous a entendu murmurer 'Ça va être gras'. Des traces de soufre retrouvées sur votre serviette brodée.","Goûteur officiel, vous avez refusé la mousse avant la détonation. Un ticket pour 2kg de poudre noire trouvé dans votre poche. Des lunettes de protection portées sous votre masque de bal.","Votre tablier présente des résidus de combustion. Absent à l'appel de 20h malgré votre présence déclarée. Un détonateur caché dans votre chaussette gauche lors de la fouille."]},
  {t:"Le Massacre des Mimes Silencieux",d:"Le 22 Mars, le Festival du Mime de Strasbourg a tourné au drame. 12 artistes retrouvés enfermés dans des boîtes de plexiglas blindé de 4cm. Le public a applaudi 20 minutes croyant à une performance. On soupçonne un ex-clown traumatisé par le silence de ses collègues mimes.",wI:["Maquillage","Geste","Silence"],wI2:["Rideau","Applaudissement"],wG:["Asphyxie","Plexiglas","Vengeance"],wG2:["Oxygène","Outil"],susp:["40 plaques de plexiglas retrouvées dans votre garage. Flashé en train de transporter une boîte géante sur votre voiture à 4h du matin. Explication : 'aquarium pour baleine imaginaire'.","Entendu dire 'Ils vont enfin la boucler pour de bon' avant la répétition. Mains couvertes de colle forte industrielle. Nez rouge en plastique sous votre masque anti-gaz à l'interpellation.","Votre badge a verrouillé la salle 3 minutes avant le massacre. Prétendu sourd-muet pour échapper à l'interrogatoire, mais entendu hurler de rire dans les vestiaires juste après."]},
  {t:"Le Vol du Brie de Meaux Présidentiel",d:"Dans la nuit du 3 au 4 Septembre, la cave à fromages de l'Élysée a été cambriolée. Un Brie affiné 47 ans, estampillé Patrimoine de la République, a disparu. Le voleur a neutralisé 14 caméras avec de la crème fraîche et contourné les lasers avec des miroirs en fromage de chèvre séché.",wI:["Affinage","Croûte","Cave"],wI2:["Dégustation","Terroir"],wG:["Cambriolage","Crème","Miroir"],wG2:["Alarme","Neutraliser"],susp:["Carte bancaire utilisée pour acheter 3 litres de crème fraîche à 23h47 la veille. Fiché à l'Office des Fraudes Fromagères. Manteau qui sentait l'Époisse fermenté à 2 mètres.","Traces ADN de Brie sous les ongles en garde à vue. Seul visiteur à avoir demandé à voir la cave lors de la visite protocolaire. Plan annoté de la cave retrouvé sous votre matelas.","Traces de pneus dans le gazon nord de l'Élysée correspondant à votre véhicule. Le chien renifleur de l'unité fromagère a tiré directement vers vous. Miroir de chèvre séché dans votre coffre."]},
  {t:"L'Empoisonnement au Café de la Sous-Préfecture",d:"Le 7 Novembre, la machine Nespresso de la Sous-Préfecture de Vierzon a subi une panne catastrophique. Quelqu'un avait remplacé les capsules par des gélules de chicorée périmée, provoquant des réunions interminables et une incapacité totale à décider avant 17h30.",wI:["Capsule","Expresso","Mouture"],wI2:["Percolateur","Crema"],wG:["Chicorée","Sabotage","Gélule"],wG2:["Intoxication","Dosette"],susp:["Seul à avoir refusé le café ce matin-là, prétextant un régime décaféiné subitement adopté. Rôdé près de la machine à 7h34, 23 minutes avant l'ouverture. 47 capsules vides dans vos poubelles.","Sac isotherme suspect transporté vers le local café la veille au soir. CV mentionnant une certification en manipulation de fluides caféinés. Gants chirurgicaux pour faire des photocopies.","Badge badgé à 23h12 la veille. Absent lors de chaque réunion de plus de 4h ces six derniers mois. Vos empreintes identifiées sur la cartouche de réserve par le laboratoire."]},
  {t:"La Grande Escroquerie au Pétanque de Monaco",d:"Lors du Tournoi International de Pétanque Royale du 15 Juillet, les cochonnets avaient été remplacés par des leurres holographiques télécommandés. Le coupable déplaçait les cochonnets depuis les tribunes pour encaisser des mises auprès de bookmakers clandestins à Andorre.",wI:["Cochonnet","Pointeur","Mèle"],wI2:["Terrain","Boule"],wG:["Hologramme","Télécommande","Mise"],wG2:["Arnaque","Clandestin"],susp:["Téléphone émettant des signaux Bluetooth à haute fréquence pendant tout le tournoi. Photographié en train de manipuler une télécommande dissimulée dans un programme officiel. 80 000€ misés sur le perdant à 1/47.","Ingénieur en holographie avec accès à du matériel miniaturisé classifié. Virement de 340 000€ d'un compte andorran crédité le lendemain du tournoi. Aucune explication fournie.","Résidus de résine holographique sous vos chaussures de sport. Casier mentionnant une escroquerie au concours de Béziers 2018. Empreinte relevée sur le générateur holographique dans la remise."]},
  {t:"Le Détournement du Carnaval de Nice",d:"Le 20 Février, le char du Roi Carnaval a mystérieusement dévié vers la Banque Régionale de la Côte d'Azur. Le conducteur, sous hypnose, a enfoncé le portail avec 12 tonnes de papier mâché. Un commando en grosses têtes caricaturales a tenté de vider les coffres, en vain : ils ne voyaient rien.",wI:["Confetti","Costume","Défilé"],wI2:["Fanfare","Masque"],wG:["Casse","Hypnose","Commando"],wG2:["Coffre","Papier-mâché"],susp:["Nom figurant parmi les artisans du char. Manuel d'hypnose et coordonnées GPS de la banque trouvés dans votre atelier. Minibus de 9 places réservé sous un faux nom le soir du carnaval.","Casier : affaire de grande tête frauduleuse à Dunkerque. Résidus de papier mâché identiques au char dans votre camionnette. Empreintes relevées sur le gouvernail de direction du char.","47 masques de grosses têtes achetés en janvier, bien au-delà des besoins déclarés. Virement d'une société caïmane deux jours avant le défilé. Vidéo vous montrant repérer les lieux trois semaines avant."]},
  {t:"L'Affaire du Soufflé Sabordé",d:"Lors du 42e Concours National du Soufflé à Lyon, tous les soufflés de la finale se sont effondrés à 11h34. Une analyse révèle des vibrations à fréquence ultra-précise émises par un dispositif dans une brioche décorative. L'auteur a délibérément détruit les espoirs de 8 finalistes.",wI:["Four","Blancs","Recette"],wI2:["Moule","Levée"],wG:["Fréquence","Vibrateur","Effondrement"],wG2:["Dispositif","Brioche"],susp:["Votre soufflé le seul à ne pas s'effondrer. Appareil électronique dans votre tablier. Photographié en train de photographier les soufflés des autres à 11h30 précises.","Ingénieur acoustique de formation. Brioche décorative apportée avec un espace creux inexpliqué. Mobile : défaite l'an dernier face au grand favori présent cette année.","Traces de colle thermique sur vos gants identiques à celles du dispositif. Regards échangés avec un complice présumé à 11h33, captés par vidéosurveillance."]},
  {t:"La Substitution du Beaujolais Nouveau",d:"Le troisième jeudi de Novembre, lors de la cérémonie de l'Académie du Beaujolais, les 40 membres ont simultanément recraché leur verre. Le Beaujolais avait été remplacé par un mélange de jus de raisin industriel, de vinaigre balsamique et d'eau de Cologne. Un affront sans précédent.",wI:["Cuvée","Vendange","Cépage"],wI2:["Millésime","Tanin"],wG:["Substitution","Vinaigre","Colonie"],wG2:["Imposture","Assemblage"],susp:["Sommelier avec accès à la cave la veille. Reçu d'achat de 6 litres d'eau de Cologne et vinaigre balsamique dans votre veste. Refus de goûter lors de la cérémonie.","Badge utilisé pour entrer dans la cave à 3h17 du matin. Exclusion de l'Académie il y a deux ans avec menaces publiques. Bouteilles de jus de raisin industriel dans votre voiture.","Silhouette identifiée par caméra thermique à l'heure des faits. SMS envoyé le matin : 'Ce soir ils vont boire la honte'. Empreintes sur 4 des 40 bouteilles sabotées."]}
];

function getCase(i){return CASES[i%CASES.length];}

// ══════════════════════════════════════════
// STATE
// ══════════════════════════════════════════
const S={
  code:'', isHost:false, myName:'', myRole:'accused',
  players:[], caseIdx:0, assignments:[], startTime:0
};
let selectedDay=1, flowStep=0, inspStep=0, timerInt=null, timerInt2=null;

// ══════════════════════════════════════════
// HELPERS
// ══════════════════════════════════════════
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function genCode(){return Math.random().toString(36).substr(2,4).toUpperCase();}
function err(id){const e=document.getElementById(id);e.style.display='block';setTimeout(()=>e.style.display='none',3000);}
function setBadge(code){
  document.getElementById('code-badge').style.display='block';
  document.getElementById('code-val').textContent=code;
}

// ══════════════════════════════════════════
// HOME
// ══════════════════════════════════════════
function pickRole(r){
  S.myRole=r;
  document.getElementById('rbtn-inv').classList.toggle('active',r==='investigator');
  document.getElementById('rbtn-acc').classList.toggle('active',r==='accused');
}

function createGame(){
  const name=document.getElementById('inp-name').value.trim();
  if(!name){err('err-name');return;}
  S.myName=name; S.isHost=true;
  S.code=genCode();
  S.players=[{name,role:S.myRole}];
  setBadge(S.code);
  renderHostLobby();
}

function joinGame(){
  const name=document.getElementById('inp-name').value.trim();
  const code=document.getElementById('inp-code').value.trim().toUpperCase();
  if(!name){err('err-name');return;}
  if(code.length<2){err('err-code');return;}
  S.myName=name; S.isHost=false; S.code=code; S.myRole=S.myRole;
  S.players=[{name,role:S.myRole}];
  setBadge(code);
  // Show player lobby
  document.getElementById('pl-name').textContent=name;
  document.getElementById('pl-role-txt').textContent=S.myRole==='investigator'?'Inspecteur':'Accusé';
  document.getElementById('pl-code-show').textContent=code;
  show('s-player-lobby');
}

// ══════════════════════════════════════════
// HOST LOBBY
// ══════════════════════════════════════════
function renderHostLobby(){
  document.getElementById('host-code-big').textContent=S.code;
  show('s-host-lobby');
  renderPlayerList();
  buildCalendar();
}

function renderPlayerList(){
  document.getElementById('host-player-list').innerHTML=S.players.map(p=>`
    <div class="player-card ${p.role==='investigator'?'inv':''}">
      <span class="pname">> ${p.name.toUpperCase()}</span>
      <span class="pbadge ${p.role==='investigator'?'police':''}">${p.role==='investigator'?'POLICE':'SUSPECT'}</span>
    </div>
  `).join('');
}

function addPlayerManual(){
  const name=prompt('Nom du joueur :');
  if(!name||!name.trim())return;
  const isInv=confirm(name+' est Inspecteur ? (OK=Inspecteur / Annuler=Accusé)');
  S.players.push({name:name.trim(),role:isInv?'investigator':'accused'});
  renderPlayerList();
}

function buildCalendar(){
  const cal=document.getElementById('host-cal');
  if(cal.children.length)return;
  for(let i=1;i<=30;i++){
    const d=document.createElement('div');
    d.className='cal-day'+(i===1?' sel':'');
    d.textContent=i;
    d.onclick=()=>{selectedDay=i;cal.querySelectorAll('.cal-day').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');};
    cal.appendChild(d);
  }
}

// ══════════════════════════════════════════
// HOST BRIEFING
// ══════════════════════════════════════════
function hostGoBriefing(){
  S.caseIdx=selectedDay-1;
  // Assign roles
  const sc=getCase(S.caseIdx);
  const suspects=S.players.filter(p=>p.role!=='investigator');
  const gIdx=Math.floor(Math.random()*Math.max(suspects.length,1));
  S.assignments=S.players.map(p=>{
    if(p.role==='investigator')return{...p,verdict:'Enquêteur',words:[],words2:[],suspicion:''};
    const si=suspects.findIndex(s=>s.name===p.name);
    const isG=si===gIdx;
    return{...p,verdict:isG?'Coupable':'Innocent',words:isG?sc.guiltyWords:sc.innocentWords,words2:isG?sc.guiltyWords2:sc.innocentWords2,suspicion:sc.suspicionBases[si%sc.suspicionBases.length]};
  });
  S.startTime=Date.now();

  const sc2=getCase(S.caseIdx);
  document.getElementById('bh-day').textContent='JOUR '+(S.caseIdx+1);
  document.getElementById('bh-title').textContent=sc2.t;
  document.getElementById('bh-desc').textContent=sc2.d;

  // Suspect list for host
  document.getElementById('bh-suspect-list').innerHTML=S.assignments.filter(a=>a.verdict!=='Enquêteur').map(a=>`
    <div class="suspect-card ${a.verdict==='Coupable'?'guilty':''}">
      <div class="sname"><span>${a.name}</span><span class="srole ${a.verdict==='Coupable'?'g':'i'}">${a.verdict}</span></div>
      <div class="spv">${a.suspicion}</div>
      <div class="swords"><span class="sword-label">T1:</span> ${a.words.join(' / ')}</div>
    </div>
  `).join('');

  show('s-briefing-host');
}

function hostLaunch(){
  // Go to inspector flow
  const sc=getCase(S.caseIdx);
  // Fill inspector screens
  document.getElementById('i1-day').textContent=S.caseIdx+1;
  document.getElementById('i1-title').textContent=sc.t;
  document.getElementById('i1-desc').textContent=sc.d;
  document.getElementById('i-day').textContent='J.'+(S.caseIdx+1);
  document.getElementById('i-day2').textContent='J.'+(S.caseIdx+1);

  // Suspect list tour 1
  document.getElementById('insp-suspect-list').innerHTML=S.assignments.filter(a=>a.verdict!=='Enquêteur').map(a=>`
    <div class="suspect-card ${a.verdict==='Coupable'?'guilty':''}">
      <div class="sname"><span>${a.name}</span><span class="srole ${a.verdict==='Coupable'?'g':'i'}">${a.verdict}</span></div>
      <div class="spv">"${a.suspicion}"</div>
      <div class="swords"><span class="sword-label">T1:</span> ${a.words.join(' / ')}</div>
    </div>
  `).join('');

  // Suspect list tour 2
  document.getElementById('insp-suspect-list2').innerHTML=S.assignments.filter(a=>a.verdict!=='Enquêteur').map(a=>`
    <div class="suspect-card ${a.verdict==='Coupable'?'guilty':''}">
      <div class="sname"><span>${a.name}</span><span class="srole ${a.verdict==='Coupable'?'g':'i'}">${a.verdict}</span></div>
      <div class="swords">
        <span class="sword-label">T1:</span> ${a.words.join(' / ')}<br>
        <span class="sword-label r" style="margin-top:4px;display:inline-block;">T2:</span> ${a.words2.join(' / ')}
      </div>
    </div>
  `).join('');

  inspStep=0;
  buildDots('insp-dots',4,0);
  showInspStep(0);
  show('s-inspector-flow');
}

// ══════════════════════════════════════════
// INSPECTOR STEPS
// ══════════════════════════════════════════
function buildDots(containerId,total,current){
  const el=document.getElementById(containerId);
  el.innerHTML='';
  for(let i=0;i<total;i++){
    const d=document.createElement('div');
    d.className='dot'+(i<current?' done':i===current?' active':'');
    el.appendChild(d);
  }
}

function showInspStep(n){
  document.querySelectorAll('#s-inspector-flow .flow-step').forEach(s=>s.classList.remove('active'));
  document.getElementById('istep-'+n).classList.add('active');
  buildDots('insp-dots',4,n);
}

function nextInspStep(){
  inspStep++;
  if(inspStep===2){startTimer('i-timer',S.startTime);}
  if(inspStep===3){startTimer2('i-timer2');}
  showInspStep(inspStep);
}

function inspReset(){
  if(timerInt)clearInterval(timerInt);
  if(timerInt2)clearInterval(timerInt2);
  S.players=S.players;
  renderHostLobby();
}

// ══════════════════════════════════════════
// PLAYER FLOW (called from lobby when host launches)
// ══════════════════════════════════════════
function startPlayerFlow(assignment){
  const sc=getCase(S.caseIdx);
  const day='JOUR '+(S.caseIdx+1);

  // Fill all steps
  document.getElementById('p0-day').textContent=day;
  const roleEl=document.getElementById('p0-role');
  roleEl.textContent=assignment.verdict;
  roleEl.style.color=assignment.verdict==='Coupable'?'#991b1b':'#1e293b';

  document.getElementById('p1-title').textContent=sc.t;
  document.getElementById('p1-desc').textContent=sc.d;
  document.getElementById('p2-name').textContent=assignment.name;
  document.getElementById('p3-pv').textContent=assignment.suspicion;

  document.getElementById('p4-words').innerHTML=assignment.words.map(w=>`<div class="word-card">${w}</div>`).join('');
  document.getElementById('p5-words').innerHTML=[...assignment.words,...assignment.words2].map(w=>`<div class="word-card">${w}</div>`).join('');

  document.getElementById('p-day').textContent='J.'+(S.caseIdx+1);
  document.getElementById('p-day2').textContent='J.'+(S.caseIdx+1);

  flowStep=0;
  buildDots('flow-dots',6,0);
  showFlowStep(0);
  show('s-player-flow');
}

function showFlowStep(n){
  document.querySelectorAll('#s-player-flow .flow-step').forEach(s=>s.classList.remove('active'));
  document.getElementById('step-'+n).classList.add('active');
  buildDots('flow-dots',6,n);
}

function nextStep(){
  flowStep++;
  if(flowStep===4){startTimer('p-timer',S.startTime);}
  if(flowStep===5){startTimer2('p-timer2');}
  showFlowStep(flowStep);
}

// ══════════════════════════════════════════
// TIMERS
// ══════════════════════════════════════════
function startTimer(elId,ts){
  if(timerInt)clearInterval(timerInt);
  const el=document.getElementById(elId);
  const base=ts||Date.now();
  timerInt=setInterval(()=>{
    const rem=Math.max(0,90-Math.floor((Date.now()-base)/1000));
    el.textContent=fmt(rem);
    if(rem===0)clearInterval(timerInt);
  },500);
}
function startTimer2(elId){
  if(timerInt2)clearInterval(timerInt2);
  const el=document.getElementById(elId);
  let rem=90;
  timerInt2=setInterval(()=>{
    rem=Math.max(0,rem-1);
    el.textContent=fmt(rem);
    if(rem===0)clearInterval(timerInt2);
  },1000);
}
function fmt(s){return Math.floor(s/60).toString().padStart(2,'0')+':'+(s%60).toString().padStart(2,'0');}

// ══════════════════════════════════════════
// DEMO / TEST (host can also test player flow)
// ══════════════════════════════════════════
// For now the player lobby has a "start" button that host activates
// Since there's no real-time sync, host tells players verbally to click

// Add a button in player lobby to manually trigger (host says "go")
document.getElementById('s-player-lobby').insertAdjacentHTML('beforeend',`
  <button class="btn btn-red" style="margin-top:12px;" onclick="playerManualStart()">Le commissaire a lancé — Commencer →</button>
`);

function playerManualStart(){
  // Player enters their name to get their assignment
  // Since no server, host tells each player their assignment verbally OR
  // we use a simple name lookup from a shared state encoded in URL
  const myAssignment={
    name:S.myName,
    verdict: S.myRole==='investigator'?'Enquêteur':'(en attente)',
    words:[], words2:[], suspicion:'En attente des informations du commissaire.'
  };
  // If investigator
  if(S.myRole==='investigator'){
    alert("Vous êtes Inspecteur. Utilisez l'écran de l'hôte pour voir les suspects.");
    return;
  }
  startPlayerFlow(myAssignment);
}
</script>

</body>
</html>
