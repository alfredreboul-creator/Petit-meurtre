<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Archives Criminelles</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root { --blood:#991b1b; --paper:#f1f0ea; --ink:#111827; }
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Courier Prime',monospace;background:#0a0a0a;color:#e5e7eb;min-height:100vh;padding:16px;display:flex;flex-direction:column;align-items:center;}
.elite{font-family:'Special Elite',serif;}

/* HEADER */
header{width:100%;max-width:480px;border-bottom:6px solid #7f1d1d;padding-bottom:12px;margin-bottom:24px;display:flex;justify-content:space-between;align-items:flex-end;}
h1{font-family:‘Special Elite’,serif;font-size:1.6rem;color:#991b1b;text-transform:uppercase;letter-spacing:-0.02em;}
.subtitle{font-size:8px;color:#52525b;letter-spacing:0.35em;font-weight:700;margin-top:2px;}

/* SCREENS */
.screen{width:100%;max-width:480px;display:none;}
.screen.active{display:block;}

/* FOLDER */
.folder{background:var(–paper);color:var(–ink);box-shadow:8px 8px 0 #000;border:1px solid #94a3b8;padding:24px;margin-bottom:16px;position:relative;}
.stamp{border:4px solid var(–blood);color:var(–blood);padding:3px 12px;text-transform:uppercase;font-weight:900;transform:rotate(-10deg);display:inline-block;font-family:‘Special Elite’;font-size:1rem;margin-bottom:16px;}
.stamp.inline{transform:none;font-size:0.7rem;border-width:2px;margin-bottom:0;}

/* BUTTONS */
.btn{display:block;width:100%;padding:18px;font-family:‘Special Elite’;font-size:1.1rem;text-transform:uppercase;letter-spacing:0.1em;cursor:pointer;border:none;text-align:center;}
.btn-red{background:#991b1b;color:#fff;border-bottom:5px solid #450a0a;transition:transform 0.1s,border-bottom-width 0.1s;}
.btn-red:active{transform:translateY(3px);border-bottom-width:2px;}
.btn-dark{background:#18181b;color:#a1a1aa;border:2px solid #27272a;margin-top:8px;}
.btn-dark:active{background:#27272a;}

/* INPUTS */
input[type=text]{width:100%;background:#fff;border:none;border-bottom:4px solid #d4d4d8;padding:14px;font-size:1.3rem;font-weight:700;font-family:‘Courier Prime’,monospace;outline:none;color:#111;margin-bottom:4px;}
input[type=text]:focus{border-bottom-color:#991b1b;}
label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#71717a;margin-bottom:6px;margin-top:16px;}

/* ROLES */
.role-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0;}
.role-btn{border:2px solid #27272a;padding:16px 8px;text-align:center;cursor:pointer;background:#0a0a0a;transition:0.2s;}
.role-btn.active{border-color:#991b1b;background:#1a0505;}
.role-btn span{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:#a1a1aa;}
.role-btn small{font-size:9px;color:#52525b;font-style:italic;margin-top:4px;display:block;}

/* PLAYER LIST */
.player-item{display:flex;justify-content:space-between;align-items:center;background:#18181b;border-left:4px solid #27272a;padding:12px 16px;margin-bottom:8px;}
.player-item.inv{border-left-color:#991b1b;}
.player-name{font-weight:900;color:#d4d4d8;letter-spacing:0.05em;}
.player-badge{font-size:8px;font-weight:700;padding:3px 8px;background:#000;letter-spacing:0.2em;border:1px solid #27272a;color:#71717a;}
.player-badge.police{border-color:#7f1d1d;color:#dc2626;}

/* CALENDAR */
.cal-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:12px;}
.cal-day{aspect-ratio:1;background:#111;border:2px solid #222;display:flex;align-items:center;justify-content:center;font-family:‘Special Elite’;font-size:1.2rem;cursor:pointer;transition:0.2s;}
.cal-day.sel{background:#991b1b;color:#fff;border-color:#ef4444;box-shadow:0 0 15px #991b1b88;transform:scale(1.08);}

/* QR */
#qr-container{background:#fff;padding:16px;display:inline-block;margin:16px auto;display:flex;justify-content:center;}
#qr-container canvas,#qr-container img{max-width:200px!important;height:auto!important;}
.qr-wrap{text-align:center;}
.qr-instruction{font-size:10px;color:#71717a;text-transform:uppercase;letter-spacing:0.2em;margin-top:8px;}

/* GAME */
.timer-block{border-bottom:2px solid #7f1d1d;padding-bottom:16px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
.timer{font-size:4.5rem;font-weight:900;color:#fff;letter-spacing:-0.05em;line-height:1;}
.phase-tag{display:inline-block;background:#7f1d1d;color:#fff;font-size:9px;font-weight:700;padding:4px 10px;text-transform:uppercase;letter-spacing:0.2em;margin-top:6px;}
.day-tag{font-family:‘Special Elite’;font-size:2rem;color:#7f1d1d;font-weight:900;}

.suspect-block{border-left:6px solid #111;padding-left:16px;margin-bottom:24px;}
.suspect-name{font-size:1.1rem;font-weight:900;text-transform:uppercase;border-bottom:2px solid rgba(0,0,0,0.1);padding-bottom:4px;margin-bottom:8px;display:flex;justify-content:space-between;}
.role-guilty{color:#991b1b;text-decoration:underline;}
.role-innocent{color:#52525b;}
.pv-text{font-size:10px;color:#52525b;font-style:italic;line-height:1.5;margin-bottom:8px;}
.words-line{font-size:11px;font-weight:700;}
.words-label{background:#111;color:#fff;padding:1px 6px;font-size:9px;margin-right:4px;}
.words-label.r{background:#7f1d1d;}

/* ACCUSED VIEW */
.accused-role{font-size:3rem;font-weight:900;text-transform:uppercase;letter-spacing:-0.03em;line-height:1;margin:8px 0 20px;}
.accused-pv{font-size:12px;line-height:1.8;font-weight:700;font-style:italic;color:#374151;}
.word-card{background:#fff;border-left:6px solid #991b1b;padding:16px 20px;margin-bottom:10px;font-size:1.4rem;font-weight:900;text-transform:uppercase;letter-spacing:-0.02em;color:#111;}

/* STATUS */
.waiting-box{background:#18181b;border:1px solid #27272a;border-radius:4px;padding:24px;text-align:center;margin-bottom:16px;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

.error{background:#450a0a;border:1px solid #991b1b;color:#fca5a5;padding:10px;font-size:11px;font-weight:700;text-transform:uppercase;display:none;margin-top:8px;}

/* TABS */
.tab-row{display:flex;gap:2px;margin-bottom:16px;}
.tab{flex:1;padding:10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;cursor:pointer;background:#18181b;color:#71717a;border:none;border-bottom:2px solid #27272a;}
.tab.active{color:#fff;border-bottom-color:#991b1b;background:#1a0505;}

.section{display:none;}
.section.active{display:block;}
</style>

</head>
<body>

<header>
  <div>
    <h1 class="elite">Archives Criminelles</h1>
    <p class="subtitle">Accès restreint // Sécurité nationale</p>
  </div>
  <div id="code-badge" style="display:none;text-align:right;">
    <div style="font-size:8px;color:#52525b;font-weight:700;text-transform:uppercase;">Session</div>
    <div id="code-display" style="font-size:1.2rem;font-weight:900;color:#fff;font-family:monospace;background:#7f1d1d33;padding:2px 10px;border:1px solid #7f1d1d44;border-radius:2px;letter-spacing:0.2em;"></div>
  </div>
</header>

<!-- ═══════════════════════════════ HOME ═══════════════════════════════ -->

<div id="screen-home" class="screen active">
  <div class="folder">
    <div class="stamp">Identité</div>
    <h3 class="elite" style="font-size:1.3rem;font-weight:900;text-decoration:underline;text-decoration-color:#991b1b;text-decoration-thickness:3px;margin-bottom:20px;">Qui se présente ?</h3>
    <div class="role-grid">
      <div class="role-btn" id="btn-inv" onclick="selectRole(true)">
        <span>L'Inspecteur</span>
        <small>Interroge &amp; dirige</small>
      </div>
      <div class="role-btn active" id="btn-acc" onclick="selectRole(false)">
        <span>L'Accusé</span>
        <small>Ment pour survivre</small>
      </div>
    </div>
    <label>Matricule ou alias</label>
    <input type="text" id="inp-name" placeholder="Votre nom...">
    <div id="err-name" class="error">Renseignez votre nom avant de continuer.</div>
  </div>

<button class="btn btn-red" onclick="createGame()">Ouvrir un dossier</button>

  <div style="margin-top:20px;" class="folder">
    <label>Code de session</label>
    <input type="text" id="inp-code" placeholder="EX: A1B2" maxlength="4" style="text-transform:uppercase;letter-spacing:0.3em;">
    <div id="err-join" class="error">Code invalide. Vérifiez avec l'hôte.</div>
    <button class="btn btn-dark" style="margin-top:12px;" onclick="joinGame()">Rejoindre la session</button>
  </div>
</div>

<!-- ═══════════════════════════════ LOBBY HOST ═══════════════════════════════ -->

<div id="screen-lobby-host" class="screen">
  <div class="folder">
    <div class="stamp">Commissariat</div>
    <p style="font-size:10px;color:#52525b;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:4px;">Vous dirigez l'enquête</p>
    <p style="font-size:12px;color:#374151;margin-bottom:16px;">Partagez le code ou le QR ci-dessous avec les joueurs.</p>
    <div class="qr-wrap">
      <div id="qr-lobby" style="display:flex;justify-content:center;background:#fff;padding:12px;"></div>
      <p class="qr-instruction">Scanner pour rejoindre</p>
      <p style="font-size:10px;color:#71717a;margin-top:4px;">Ou code : <strong id="code-share" style="color:#fff;letter-spacing:0.3em;"></strong></p>
    </div>
  </div>

  <div class="folder">
    <h3 style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#71717a;margin-bottom:12px;">Présents :</h3>
    <div id="host-player-list"></div>
    <button class="btn btn-dark" style="margin-top:8px;font-size:10px;" onclick="refreshPlayers()">↻ Actualiser la liste</button>
  </div>

  <div class="folder">
    <h3 class="elite" style="color:#991b1b;font-size:1rem;font-weight:700;margin-bottom:12px;text-decoration:underline;">Choisir l'affaire</h3>
    <div class="cal-grid" id="host-calendar"></div>
  </div>

<button class="btn btn-red" onclick="hostStartBriefing()" style="margin-top:4px;">Diffuser le rapport de crime</button>

</div>

<!-- ═══════════════════════════════ LOBBY PLAYER ═══════════════════════════════ -->

<div id="screen-lobby-player" class="screen">
  <div class="folder">
    <div class="stamp">Mise en examen</div>
    <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;color:#52525b;margin-bottom:8px;">Vous êtes : accusé</p>
    <p id="player-welcome" style="font-size:1.3rem;font-weight:900;color:#111;"></p>
  </div>
  <div class="waiting-box">
    <p class="pulse" style="font-size:10px;color:#991b1b;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;">Dossier en cours d'ouverture...</p>
    <p style="font-size:9px;color:#52525b;text-transform:uppercase;letter-spacing:0.1em;margin-top:8px;">Le commissaire sélectionne une affaire</p>
  </div>
  <div class="folder" style="background:#0a0a0a;color:#fff;">
    <p style="font-size:10px;color:#71717a;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:8px;">En attendant, demandez à l'hôte de scanner :</p>
    <div class="qr-wrap">
      <div id="qr-player-wait" style="display:flex;justify-content:center;background:#fff;padding:12px;"></div>
      <p class="qr-instruction" style="color:#52525b;">QR de votre statut actuel</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════ BRIEFING ═══════════════════════════════ -->

<div id="screen-briefing" class="screen">
  <div class="folder" style="max-height:70vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
      <div class="stamp">Preuve A</div>
      <span id="brief-day" class="elite" style="font-size:1.8rem;color:#991b1b;font-weight:900;"></span>
    </div>
    <h2 id="brief-title" style="font-size:1.3rem;font-weight:900;text-transform:uppercase;border-bottom:4px solid #111;padding-bottom:8px;margin-bottom:16px;line-height:1.2;"></h2>
    <div style="background:#111;color:#fff;padding:3px 10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.2em;display:inline-block;margin-bottom:12px;">Rapport d'enquête :</div>
    <p id="brief-desc" style="font-size:12px;line-height:1.8;color:#374151;font-style:italic;"></p>
  </div>
  <div id="brief-host-ctrl" style="display:none;">
    <button class="btn btn-red" onclick="hostLaunchGame()">Lancer l'interrogatoire</button>
  </div>
  <div id="brief-player-msg" class="waiting-box" style="display:none;">
    <div class="stamp inline" style="margin-bottom:8px;">Interrogatoire imminent</div>
    <p style="font-size:10px;color:#7f1d1d;font-weight:700;text-transform:uppercase;margin-top:8px;">Le commissaire analyse vos alibis...</p>
  </div>
</div>

<!-- ═══════════════════════════════ GAME HOST ═══════════════════════════════ -->

<div id="screen-game-host" class="screen">
  <div class="timer-block">
    <div>
      <div class="timer" id="h-timer">01:30</div>
      <div class="phase-tag" id="h-phase">Tour 1 : Mise en accusation</div>
    </div>
    <div class="day-tag" id="h-day"></div>
  </div>

  <div class="tab-row">
    <button class="tab active" onclick="switchTab('suspects')" id="tab-suspects">Suspects</button>
    <button class="tab" onclick="switchTab('qr')" id="tab-qr">QR → Joueurs</button>
  </div>

  <div class="section active" id="sec-suspects">
    <div class="folder" style="max-height:50vh;overflow-y:auto;">
      <div class="stamp" style="margin-bottom:12px;">Vérité nue</div>
      <div id="host-investigator-data"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button id="btn-next-round" class="btn btn-red" style="flex:1;padding:14px;font-size:0.9rem;" onclick="hostNextRound()">Tour 2 : Confrontation →</button>
      <button class="btn btn-dark" style="width:80px;margin:0;padding:14px;font-size:0.8rem;" onclick="hostReset()">Reset</button>
    </div>
  </div>

  <div class="section" id="sec-qr">
    <p style="font-size:10px;color:#71717a;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:12px;">Faites scanner ce QR aux joueurs pour leur donner leurs rôles et mots :</p>
    <div id="qr-players-list"></div>
  </div>
</div>

<!-- ═══════════════════════════════ GAME PLAYER ═══════════════════════════════ -->

<div id="screen-game-player" class="screen">
  <div class="timer-block">
    <div>
      <div class="timer" id="p-timer">01:30</div>
      <div class="phase-tag" id="p-phase">Tour 1</div>
    </div>
    <div class="day-tag" id="p-day"></div>
  </div>
  <div class="folder" style="min-height:400px;">
    <div style="position:absolute;top:16px;right:16px;opacity:0.25;" class="stamp">Accusé</div>
    <div style="margin-bottom:20px;">
      <span style="font-size:9px;font-weight:700;text-transform:uppercase;color:#9ca3af;letter-spacing:0.2em;display:block;margin-bottom:4px;">Statut judiciaire :</span>
      <div id="p-role" class="accused-role"></div>
    </div>
    <div style="margin-bottom:20px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;border-bottom:3px solid #991b1b;padding-bottom:4px;color:#991b1b;letter-spacing:0.15em;margin-bottom:10px;">Procès-verbal d'interpellation :</div>
      <p id="p-motif" class="accused-pv"></p>
    </div>
    <div>
      <div id="p-word-title" style="font-size:10px;font-weight:700;text-transform:uppercase;border-bottom:2px solid rgba(0,0,0,0.15);padding-bottom:4px;color:#7f1d1d;letter-spacing:0.15em;margin-bottom:10px;"></div>
      <div id="p-words"></div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════
// SCENARIOS
// ══════════════════════════════════════════════════
const CASES = [
  {
    t:"L'Attentat à la Mousse de Canard Explosive",
    d:"Le 12 Janvier, à la réception annuelle de l'Ambassade de Groland, un buffet de charcuterie fine a dévasté la salle de bal. Le coupable aurait dissimulé un mélange de nitroglycérine et de graisse de canard dans une terrine de foie gras millésimée. L'explosion fut si puissante qu'on retrouva des cornichons incrustés dans les tableaux de maîtres à 50 mètres. Le mobile : une vengeance pour une dégustation jugée insultante.",
    wI:["Terrine","Cornichon","Buffet"],wI2:["Pâté","Foie Gras"],
    wG:["Nitrate","Vengeance","Gavage"],wG2:["Poudre","Sabotage"],
    susp:["Vous avez été aperçu près du buffet à 19h58, tenant une cuillère en argent d'un air fiévreux. Un témoin vous a entendu murmurer 'Ça va être gras, très gras'. Des traces de soufre ont été retrouvées sur votre serviette brodée.",
          "En tant que goûteur officiel, pourquoi avez-vous refusé de toucher la mousse de canard avant la détonation ? Un ticket de caisse pour 2kg de poudre noire a été trouvé dans votre poche de gala. Expliquez les lunettes de protection sous votre masque de bal.",
          "Votre tablier présente des résidus de combustion. Le chef affirme que vous n'avez pas quitté le garde-manger, pourtant vous étiez absent à l'appel de 20h. Un détonateur caché dans votre chaussette gauche lors de la fouille."]
  },
  {
    t:"Le Massacre des Mimes Silencieux",
    d:"Le 22 Mars, le Festival du Mime de Strasbourg a tourné au drame. 12 artistes ont été retrouvés enfermés dans des boîtes de plexiglas blindé de 4cm. Le public a applaudi 20 minutes croyant à une performance. On soupçonne un ex-clown traumatisé par le silence.",
    wI:["Maquillage","Geste","Silence"],wI2:["Rideau","Applaudissement"],
    wG:["Asphyxie","Plexiglas","Vengeance"],wG2:["Oxygène","Outil"],
    susp:["La police a retrouvé 40 plaques de plexiglas dans votre garage. Vous avez été flashé transportant une boîte géante sur votre voiture à 4h du matin. L'histoire de l'aquarium pour baleine imaginaire ne tient pas.",
          "Un témoin vous a entendu dire 'Ils vont enfin la boucler pour de bon' avant la répétition. Vos mains sont couvertes de colle forte. Pourquoi portiez-vous un nez rouge sous votre masque anti-gaz ?",
          "Votre badge a verrouillé la salle exactement 3 minutes avant le massacre. Vous prétendiez être sourd-muet, mais on vous a entendu hurler de rire dans les vestiaires après l'incident."]
  },
  {
    t:"Le Vol du Brie de Meaux Présidentiel",
    d:"Dans la nuit du 3 au 4 Septembre, la cave à fromages de l'Élysée a été cambriolée. Un Brie de Meaux affiné 47 ans — estampillé Patrimoine de la République — a disparu. Le voleur a neutralisé 14 caméras avec de la crème fraîche et contourné les lasers avec des miroirs en fromage de chèvre séché.",
    wI:["Affinage","Croûte","Cave"],wI2:["Dégustation","Terroir"],
    wG:["Cambriolage","Crème","Miroir"],wG2:["Alarme","Neutraliser"],
    susp:["Votre carte bancaire a acheté 3 litres de crème fraîche à 23h47 la veille. Vous êtes fiché à l'Office des Fraudes Fromagères pour une affaire de Camembert synthétique en 2019. Pourquoi votre manteau sent l'Époisse fermenté ?",
          "Des traces ADN de Brie ont été retrouvées sous vos ongles en garde à vue. Vous êtes le seul visiteur ayant demandé à voir la cave lors de la visite protocolaire. Expliquez le plan annoté de la cave trouvé sous votre matelas.",
          "Votre voiture présente des traces dans le gazon nord de l'Élysée. Le chien renifleur a tiré directement vers vous à la parade. Un miroir de chèvre séché a été retrouvé dans votre coffre."]
  },
  {
    t:"L'Empoisonnement au Café de la Sous-Préfecture",
    d:"Le 7 Novembre, la machine Nespresso de la Sous-Préfecture de Vierzon a subi une panne catastrophique. Quelqu'un avait remplacé les capsules par des gélules de chicorée périmée et marc de café des années 80, provoquant des réunions interminables et une incapacité à décider avant 17h30.",
    wI:["Capsule","Expresso","Mouture"],wI2:["Percolateur","Crema"],
    wG:["Chicorée","Sabotage","Gélule"],wG2:["Intoxication","Dosette"],
    susp:["Vous seul avez refusé le café ce matin-là, prétextant un régime décaféiné adopté subitement. Vous avez rôdé près de la machine à 7h34, soit 23 min avant l'ouverture. Vos poubelles contenaient 47 capsules vides.",
          "Le service de nettoyage vous a vu avec un sac isotherme suspect le soir précédent. Votre bilan de compétences mentionne une certification en manipulation de fluides caféinés. Pourquoi portiez-vous des gants chirurgicaux pour faire des photocopies ?",
          "Votre badge a badgé à 23h12 la veille. Vous étiez absent lors de chaque réunion de plus de 4 heures ces six derniers mois. Vos empreintes ont été identifiées sur la cartouche de réserve."]
  },
  {
    t:"La Grande Escroquerie au Pétanque de Monaco",
    d:"Lors du Tournoi International de Pétanque Royale du 15 Juillet, les cochonnets avaient été remplacés par des leurres holographiques télécommandés. Le coupable, depuis les tribunes, déplaçait les cochonnets pour faire perdre les favorites et encaisser des mises auprès de bookmakers clandestins à Andorre.",
    wI:["Cochonnet","Pointeur","Mèle"],wI2:["Terrain","Boule"],
    wG:["Hologramme","Télécommande","Mise"],wG2:["Arnaque","Clandestin"],
    susp:["Votre téléphone a émis des signaux Bluetooth à haute fréquence tout au long du tournoi. Vous avez été photographié manipulant ce qui ressemble à une télécommande dans un programme officiel. Pourquoi avez-vous misé 80 000€ sur le perdant à 1/47 ?",
          "Vous êtes ingénieur en holographie et votre badge vous donne accès à du matériel miniaturisé classifié. Un virement de 340 000€ d'un compte andorran a été crédité le lendemain. Expliquez.",
          "Des traces de résine holographique ont été retrouvées sous vos chaussures. Votre casier mentionne une escroquerie au concours de boules de Béziers 2018. Votre empreinte est sur le générateur holographique dans la remise."]
  },
  {
    t:"Le Détournement du Carnaval de Nice",
    d:"Le 20 Février, le char du Roi Carnaval a mystérieusement dévié vers la Banque Régionale de la Côte d'Azur. Le conducteur, sous hypnose selon ses dires, a enfoncé le portail avec 12 tonnes de papier mâché. Un commando en costumes de grosses têtes a tenté de vider les coffres — en vain, car ils ne voyaient rien à travers les masques.",
    wI:["Confetti","Costume","Défilé"],wI2:["Fanfare","Masque"],
    wG:["Casse","Hypnose","Commando"],wG2:["Coffre","Papier-mâché"],
    susp:["Votre nom figure parmi les artisans du char. Un manuel d'hypnose et les coordonnées GPS de la banque ont été trouvés dans votre atelier. Pourquoi avez-vous réservé un minibus de 9 places sous un faux nom le soir du carnaval ?",
          "Votre casier mentionne une affaire de grande tête frauduleuse au carnaval de Dunkerque. Des résidus de papier mâché identiques au char ont été retrouvés dans votre camionnette. Vos empreintes sont sur le gouvernail de direction.",
          "Vous avez acheté 47 masques de grosses têtes en janvier, bien plus que pour votre atelier déclaré. Un virement d'une société écran caïmane a été reçu deux jours avant le défilé. Une vidéo vous montre repérer les lieux trois semaines avant."]
  },
  {
    t:"L'Affaire du Soufflé Sabordé au Concours National",
    d:"Lors du 42e Concours National du Soufflé à Lyon, tous les soufflés de la finale se sont effondrés simultanément à 11h34. Une analyse révèle la présence de vibrations à fréquence ultra-précise dans la salle, émises par un dispositif dissimulé dans une brioche décorative. L'auteur a délibérément détruit les espoirs de 8 pâtissiers finalistes.",
    wI:["Four","Blancs","Recette"],wI2:["Moule","Levée"],
    wG:["Fréquence","Vibrateur","Effondrement"],wG2:["Dispositif","Brioche"],
    susp:["Votre soufflé a été le seul à ne pas s'effondrer grâce à une préparation bizarre que vous refusez d'expliquer. Un appareil électronique miniaturisé a été retrouvé dans votre tablier. Vous avez photographié les soufflés des autres à 11h30 précises.",
          "Vous êtes ingénieur acoustique de formation et pâtissier amateur. La brioche décorative que vous avez apportée contient un espace creux inexpliqué. Votre mobile : vous avez perdu le concours l'an dernier face au grand favori, présent cette année.",
          "Des traces de colle thermique sur vos gants correspondent à celles utilisées pour fixer le dispositif dans la brioche. Un seul soufflé en dehors du vôtre a résisté : celui de votre complice présumé. Vos regards échangés à 11h33 ont été captés par la vidéosurveillance."]
  },
  {
    t:"La Substitution du Beaujolais Nouveau de l'Académie",
    d:"Le troisième jeudi de Novembre, lors de la cérémonie de dégustation de l'Académie du Beaujolais, les 40 membres ont simultanément recraché leur verre. Le Beaujolais Nouveau avait été remplacé par un assemblage de jus de raisin industriel, de vinaigre balsamique et d'eau de Cologne. Un affront sans précédent à la République du Vin.",
    wI:["Cuvée","Vendange","Cépage"],wI2:["Millésime","Tanin"],
    wG:["Substitution","Vinaigre","Colonie"],wG2:["Imposture","Assemblage"],
    susp:["Vous êtes sommelier et aviez accès à la cave de l'Académie la veille. Un reçu d'achat de 6 litres d'eau de Cologne et de vinaigre balsamique a été retrouvé dans votre veste. Vous avez refusé de goûter le vin lors de la cérémonie.",
          "Votre badge a été utilisé pour entrer dans la cave à 3h17 du matin. Un ancien membre de l'Académie témoigne que vous avez juré vengeance lors de votre exclusion il y a deux ans. Des bouteilles vides de jus de raisin industriel ont été retrouvées dans votre voiture.",
          "La caméra thermique de la cave montre votre silhouette à l'heure des faits. Vous avez envoyé un SMS le matin même disant 'Ce soir ils vont boire la honte'. Vos empreintes sont sur 4 des 40 bouteilles sabotées."]
  }
];

function getCase(idx){ return CASES[idx % CASES.length]; }

// ══════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════
let STATE = {
  code: '',
  isHost: false,
  myName: '',
  myRole: '', // 'investigator' | 'accused'
  players: [], // [{name, role:'investigator'|'accused'}]
  phase: 'lobby', // lobby | briefing | playing
  caseIdx: 0,
  round: 1,
  assignments: [], // [{name, role:'Coupable'|'Innocent'|'Enquêteur', words, words2, suspicion}]
  startTime: 0,
};

let timerInt = null;

// ══════════════════════════════════════════════════
// HELPERS
// ══════════════════════════════════════════════════
function genCode(){ return Math.random().toString(36).substr(2,4).toUpperCase(); }

function show(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function switchTab(name){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  document.getElementById('sec-'+name).classList.add('active');
}

// ══════════════════════════════════════════════════
// URL STATE ENCODING
// ══════════════════════════════════════════════════
function encodeState(s){ return btoa(encodeURIComponent(JSON.stringify(s))); }
function decodeState(str){ try{ return JSON.parse(decodeURIComponent(atob(str))); } catch(e){ return null; } }

function buildPlayerURL(playerData){
  // Build a URL with the player's specific data
  const url = new URL(window.location.href.split('#')[0].split('?')[0]);
  url.searchParams.set('join', encodeState(playerData));
  return url.toString();
}

function buildLobbyURL(code){
  const url = new URL(window.location.href.split('#')[0].split('?')[0]);
  url.searchParams.set('code', code);
  return url.toString();
}

// ══════════════════════════════════════════════════
// QR CODE GENERATION
// ══════════════════════════════════════════════════
function makeQR(containerId, url){
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  new QRCode(el, {
    text: url,
    width: 180,
    height: 180,
    colorDark: "#000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.M
  });
}

// ══════════════════════════════════════════════════
// INIT — check URL params
// ══════════════════════════════════════════════════
window.onload = () => {
  const params = new URLSearchParams(window.location.search);

  // Direct player data link (from host QR)
  if(params.has('join')){
    const data = decodeState(params.get('join'));
    if(data){
      STATE = { ...STATE, ...data };
      renderPlayerGame();
      return;
    }
  }

  // Lobby join link
  if(params.has('code')){
    const code = params.get('code');
    document.getElementById('inp-code').value = code;
    // Auto-fill and show join section
  }
};

// ══════════════════════════════════════════════════
// HOME ACTIONS
// ══════════════════════════════════════════════════
let selectedRole = 'accused';
function selectRole(isInv){
  selectedRole = isInv ? 'investigator' : 'accused';
  document.getElementById('btn-inv').classList.toggle('active', isInv);
  document.getElementById('btn-acc').classList.toggle('active', !isInv);
}

function createGame(){
  const name = document.getElementById('inp-name').value.trim();
  if(!name){ showErr('err-name'); return; }
  STATE.code    = genCode();
  STATE.isHost  = true;
  STATE.myName  = name;
  STATE.myRole  = selectedRole;
  STATE.players = [{ name, role: selectedRole }];
  STATE.phase   = 'lobby';
  renderHostLobby();
}

function joinGame(){
  const name = document.getElementById('inp-name').value.trim();
  const code = document.getElementById('inp-code').value.trim().toUpperCase();
  if(!name){ showErr('err-name'); return; }
  if(!code || code.length < 2){ showErr('err-join'); return; }
  STATE.code   = code;
  STATE.isHost = false;
  STATE.myName = name;
  STATE.myRole = selectedRole;
  STATE.players = [{ name, role: selectedRole }];
  renderPlayerLobby();
}

function showErr(id){ const e=document.getElementById(id); e.style.display='block'; setTimeout(()=>e.style.display='none',3000); }

// ══════════════════════════════════════════════════
// HOST LOBBY
// ══════════════════════════════════════════════════
let selectedDay = 1;

function renderHostLobby(){
  document.getElementById('code-badge').style.display = 'block';
  document.getElementById('code-display').innerText = STATE.code;
  document.getElementById('code-share').innerText = STATE.code;
  show('screen-lobby-host');

  // QR for lobby join
  makeQR('qr-lobby', buildLobbyURL(STATE.code));

  // Calendar
  const cal = document.getElementById('host-calendar');
  cal.innerHTML = '';
  for(let i=1;i<=30;i++){
    const d = document.createElement('div');
    d.className = 'cal-day' + (i===1?' sel':'');
    d.innerText = i;
    d.onclick = () => {
      selectedDay = i;
      cal.querySelectorAll('.cal-day').forEach(x=>x.classList.remove('sel'));
      d.classList.add('sel');
    };
    cal.appendChild(d);
  }

  renderHostPlayerList();
}

function renderHostPlayerList(){
  const list = document.getElementById('host-player-list');
  list.innerHTML = STATE.players.map(p => `
    <div class="player-item ${p.role==='investigator'?'inv':''}">
      <span class="player-name">> ${p.name.toUpperCase()}</span>
      <span class="player-badge ${p.role==='investigator'?'police':''}">${p.role==='investigator'?'POLICE':'SUSPECT'}</span>
    </div>
  `).join('');
}

// ── Host manually adds players by typing their name + role
function refreshPlayers(){
  const name = prompt("Nom du joueur à ajouter (laisser vide pour annuler) :");
  if(!name || !name.trim()) return;
  const roleChoice = confirm(`${name} est Inspecteur ? (OK=Inspecteur, Annuler=Accusé)`);
  STATE.players.push({ name: name.trim(), role: roleChoice ? 'investigator' : 'accused' });
  renderHostPlayerList();
}

function hostStartBriefing(){
  STATE.caseIdx = selectedDay - 1;
  STATE.phase   = 'briefing';
  renderBriefingHost();
}

// ══════════════════════════════════════════════════
// PLAYER LOBBY
// ══════════════════════════════════════════════════
function renderPlayerLobby(){
  document.getElementById('code-badge').style.display = 'block';
  document.getElementById('code-display').innerText = STATE.code;
  document.getElementById('player-welcome').innerText = STATE.myName;
  show('screen-lobby-player');
  // QR of current player status (for host to see who joined)
  makeQR('qr-player-wait', buildLobbyURL(STATE.code));
}

// ══════════════════════════════════════════════════
// BRIEFING
// ══════════════════════════════════════════════════
function renderBriefingHost(){
  const sc = getCase(STATE.caseIdx);
  document.getElementById('brief-day').innerText  = `JOUR ${STATE.caseIdx+1}`;
  document.getElementById('brief-title').innerText = sc.t;
  document.getElementById('brief-desc').innerText  = sc.d;
  document.getElementById('brief-host-ctrl').style.display  = 'block';
  document.getElementById('brief-player-msg').style.display = 'none';
  show('screen-briefing');

  // Host generates QR for each player with briefing data
  // (players scan to see the story)
}

function renderBriefingPlayer(sc, myData){
  document.getElementById('brief-day').innerText  = `JOUR ${STATE.caseIdx+1}`;
  document.getElementById('brief-title').innerText = sc.t;
  document.getElementById('brief-desc').innerText  = sc.d;
  document.getElementById('brief-host-ctrl').style.display  = 'none';
  document.getElementById('brief-player-msg').style.display = 'block';
  show('screen-briefing');
}

// ══════════════════════════════════════════════════
// GAME LAUNCH (HOST)
// ══════════════════════════════════════════════════
function hostLaunchGame(){
  const sc       = getCase(STATE.caseIdx);
  const suspects = STATE.players.filter(p => p.role !== 'investigator');
  const gIdx     = Math.floor(Math.random() * suspects.length);

  STATE.assignments = STATE.players.map((p, i) => {
    if(p.role === 'investigator'){
      return { name: p.name, role: 'Enquêteur', words: [], words2: [], suspicion: '' };
    }
    const sIdx = suspects.findIndex(s => s.name === p.name);
    const isG  = sIdx === gIdx;
    return {
      name:      p.name,
      role:      isG ? 'Coupable' : 'Innocent',
      words:     isG ? sc.guiltyWords    : sc.innocentWords,
      words2:    isG ? sc.guiltyWords2   : sc.innocentWords2,
      suspicion: sc.suspicionBases[sIdx % sc.suspicionBases.length]
    };
  });

  STATE.phase     = 'playing';
  STATE.round     = 1;
  STATE.startTime = Date.now();
  renderGameHost();
}

// ══════════════════════════════════════════════════
// GAME HOST VIEW
// ══════════════════════════════════════════════════
function renderGameHost(){
  const sc = getCase(STATE.caseIdx);
  document.getElementById('h-day').innerText = `J.${STATE.caseIdx+1}`;
  document.getElementById('h-phase').innerText = `Tour ${STATE.round} : ${STATE.round===1?'Mise en accusation':'Confrontation finale'}`;
  document.getElementById('btn-next-round').style.display = STATE.round===1?'':'none';
  show('screen-game-host');
  startTimer('h-timer');

  // Investigator data
  document.getElementById('host-investigator-data').innerHTML = STATE.assignments
    .filter(a => a.role !== 'Enquêteur')
    .map(a => `
      <div class="suspect-block">
        <div class="suspect-name">
          <span>${a.name}</span>
          <span class="${a.role==='Coupable'?'role-guilty':'role-innocent'}">${a.role}</span>
        </div>
        <div class="pv-text">"${a.suspicion}"</div>
        <div class="words-line">
          <span class="words-label">T1:</span> ${a.words.join(' / ')}
          ${STATE.round===2 ? `<br><span class="words-label r">T2:</span> ${a.words2.join(' / ')}` : ''}
        </div>
      </div>
    `).join('');

  // QR codes for each accused player
  renderPlayerQRs();
}

function renderPlayerQRs(){
  const sc  = getCase(STATE.caseIdx);
  const div = document.getElementById('qr-players-list');
  div.innerHTML = '';

  STATE.assignments.forEach(a => {
    const playerPayload = {
      code:      STATE.code,
      isHost:    false,
      myName:    a.name,
      myRole:    a.role === 'Enquêteur' ? 'investigator' : 'accused',
      caseIdx:   STATE.caseIdx,
      round:     STATE.round,
      phase:     'playing',
      startTime: STATE.startTime,
      assignment: a
    };
    const url = buildPlayerURL(playerPayload);

    const wrap = document.createElement('div');
    wrap.style.cssText = 'background:#111;border:1px solid #222;padding:16px;margin-bottom:12px;';
    wrap.innerHTML = `
      <div style="font-weight:900;font-size:1rem;text-transform:uppercase;margin-bottom:4px;color:#e5e7eb;">${a.name}</div>
      <div style="font-size:9px;color:${a.role==='Coupable'?'#dc2626':'#52525b'};font-weight:700;text-transform:uppercase;margin-bottom:10px;letter-spacing:0.15em;">${a.role}</div>
      <div style="display:flex;justify-content:center;background:#fff;padding:8px;" id="qr-${a.name.replace(/\s/g,'_')}"></div>
      <p style="font-size:9px;color:#52525b;text-align:center;margin-top:6px;text-transform:uppercase;letter-spacing:0.15em;">Faire scanner à ${a.name}</p>
    `;
    div.appendChild(wrap);
    setTimeout(() => {
      new QRCode(document.getElementById('qr-'+a.name.replace(/\s/g,'_')), {
        text: url, width: 150, height: 150,
        colorDark: "#000", colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M
      });
    }, 50);
  });
}

function hostNextRound(){
  STATE.round     = 2;
  STATE.startTime = Date.now();
  renderGameHost();
}

function hostReset(){
  if(!confirm('Classer cette affaire et retourner au lobby ?')) return;
  clearInterval(timerInt);
  STATE.phase   = 'lobby';
  STATE.players = STATE.players; // keep players
  renderHostLobby();
}

// ══════════════════════════════════════════════════
// GAME PLAYER VIEW (from QR scan)
// ══════════════════════════════════════════════════
function renderPlayerGame(){
  const a   = STATE.assignment;
  const sc  = getCase(STATE.caseIdx || 0);
  const isInv = STATE.myRole === 'investigator';

  document.getElementById('code-badge').style.display = 'block';
  document.getElementById('code-display').innerText = STATE.code || '????';

  if(isInv){
    // Investigator shouldn't get a player QR normally, but handle gracefully
    show('screen-briefing');
    document.getElementById('brief-day').innerText   = `JOUR ${(STATE.caseIdx||0)+1}`;
    document.getElementById('brief-title').innerText = sc.t;
    document.getElementById('brief-desc').innerText  = sc.d;
    document.getElementById('brief-host-ctrl').style.display  = 'none';
    document.getElementById('brief-player-msg').style.display = 'block';
    return;
  }

  const round = STATE.round || 1;
  document.getElementById('p-day').innerText   = `J.${(STATE.caseIdx||0)+1}`;
  document.getElementById('p-phase').innerText = `Tour ${round} : ${round===1?'Mise en accusation':'Confrontation'}`;

  const roleEl = document.getElementById('p-role');
  roleEl.innerText    = a.role;
  roleEl.style.color  = a.role === 'Coupable' ? '#991b1b' : '#1e293b';

  document.getElementById('p-motif').innerText = a.suspicion;
  document.getElementById('p-word-title').innerText = `Éléments à placer (Tour ${round}) :`;

  const words = round === 1 ? a.words : [...a.words, ...a.words2];
  document.getElementById('p-words').innerHTML = words.map(w =>
    `<div class="word-card">${w}</div>`
  ).join('');

  show('screen-game-player');
  startTimer('p-timer', STATE.startTime);
}

// ══════════════════════════════════════════════════
// TIMER
// ══════════════════════════════════════════════════
function startTimer(elId, startTs){
  if(timerInt) clearInterval(timerInt);
  const el = document.getElementById(elId);
  const ts = startTs || STATE.startTime || Date.now();
  timerInt = setInterval(() => {
    const elapsed = Math.floor((Date.now() - ts) / 1000);
    const rem = Math.max(0, 90 - elapsed);
    el.innerText = `${Math.floor(rem/60).toString().padStart(2,'0')}:${(rem%60).toString().padStart(2,'0')}`;
    if(rem === 0) clearInterval(timerInt);
  }, 500);
}
</script>

</body>
</html>
